suite: test secret-env
templates:
  - secret-env.yaml
  - deployment.yaml

tests:
  - it: should not create secret when secretEnv is empty
    set:
      nats.account: "APP"
      nats.signingKey.existingSecret: "test-signing-key"
    asserts:
      - hasDocuments:
          count: 0
        template: secret-env.yaml

  - it: should create secret when secretEnv is provided
    set:
      nats.account: "APP"
      nats.signingKey.existingSecret: "test-signing-key"
      secretEnv:
        NATS_URL: "nats://user:pass@host:4222"
        OTHER_VAR: "value"
    asserts:
      - isKind:
          of: Secret
        template: secret-env.yaml
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nats-k8s-oidc-callout-env
        template: secret-env.yaml
      - equal:
          path: data.NATS_URL
          value: bmF0czovL3VzZXI6cGFzc0Bob3N0OjQyMjI=
        template: secret-env.yaml

  - it: should reference secret in deployment when secretEnv.NATS_URL is set
    set:
      nats.account: "APP"
      nats.signingKey.existingSecret: "test-signing-key"
      secretEnv:
        NATS_URL: "nats://user:pass@host:4222"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[2].name
          value: NATS_URL
        template: deployment.yaml
      - isNotEmpty:
          path: spec.template.spec.containers[0].env[2].valueFrom
        template: deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].env[2].valueFrom.secretKeyRef.name
          value: RELEASE-NAME-nats-k8s-oidc-callout-env
        template: deployment.yaml
      - equal:
          path: spec.template.spec.containers[0].env[2].valueFrom.secretKeyRef.key
          value: NATS_URL
        template: deployment.yaml
