suite: test podmonitor
templates:
  - podmonitor.yaml
tests:
  - it: should not create PodMonitor by default
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should create PodMonitor when enabled
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PodMonitor
      - isAPIVersion:
          of: monitoring.coreos.com/v1

  - it: should have correct metadata
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nats-k8s-oidc-callout
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: ^nats-k8s-oidc-callout-

  - it: should have correct selector labels
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: nats-k8s-oidc-callout
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should use default metrics path
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].path
          value: /metrics
      - equal:
          path: spec.podMetricsEndpoints[0].port
          value: http

  - it: should allow custom metrics path
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
          path: /custom-metrics
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].path
          value: /custom-metrics

  - it: should support interval and scrapeTimeout
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
          interval: 30s
          scrapeTimeout: 10s
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].interval
          value: 30s
      - equal:
          path: spec.podMetricsEndpoints[0].scrapeTimeout
          value: 10s

  - it: should support additional labels and annotations
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
          labels:
            custom-label: value
          annotations:
            custom-annotation: value
    asserts:
      - equal:
          path: metadata.labels["custom-label"]
          value: value
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: value

  - it: should support custom namespace
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
          namespace: monitoring
    asserts:
      - equal:
          path: metadata.namespace
          value: monitoring

  - it: should support relabelings
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
          relabelings:
            - sourceLabels: [__meta_kubernetes_pod_node_name]
              targetLabel: node
    asserts:
      - contains:
          path: spec.podMetricsEndpoints[0].relabelings
          content:
            sourceLabels: [__meta_kubernetes_pod_node_name]
            targetLabel: node

  - it: should support metricRelabelings
    set:
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
      metrics:
        podMonitor:
          enabled: true
          metricRelabelings:
            - sourceLabels: [__name__]
              regex: '(go_.*)'
              action: drop
    asserts:
      - contains:
          path: spec.podMetricsEndpoints[0].metricRelabelings
          content:
            sourceLabels: [__name__]
            regex: '(go_.*)'
            action: drop
