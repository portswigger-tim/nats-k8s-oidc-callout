suite: test clusterrole
templates:
  - clusterrole.yaml
tests:
  - it: should create a ClusterRole when rbac.create is true
    set:
      rbac:
        create: true
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
    asserts:
      - isKind:
          of: ClusterRole
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nats-k8s-oidc-callout
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: ^nats-k8s-oidc-callout-

  - it: should have correct ServiceAccount permissions
    set:
      rbac:
        create: true
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
    asserts:
      - contains:
          path: rules
          content:
            apiGroups: [""]
            resources: ["serviceaccounts"]
            verbs: ["get", "list", "watch"]

  - it: should not create ClusterRole when rbac.create is false
    set:
      rbac:
        create: false
      nats:
        account: "test-account"
        credentials:
          existingSecret: "test-secret"
    asserts:
      - hasDocuments:
          count: 0
