suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: should create a Deployment with correct metadata
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nats-k8s-oidc-callout
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: ^nats-k8s-oidc-callout-

  - it: should use correct replica count
    set:
      replicaCount: 3
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use correct image with default tag
    set:
      image:
        repository: ghcr.io/test/repo
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/test/repo:v2.0.0

  - it: should use correct image with custom tag
    set:
      image:
        repository: ghcr.io/test/repo
        tag: v1.2.3
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/test/repo:v1.2.3

  - it: should set security contexts correctly
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      # Pod security context
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 65532
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 65532
      # Container security context
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.readOnlyRootFilesystem
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.capabilities.drop[0]
          value: ALL

  - it: should configure probes correctly
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      # Liveness probe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: http
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 10
      # Readiness probe
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: http
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 5

  - it: should set required NATS environment variables
    set:
      nats:
        account: "test-account"
        url: "nats://custom:4222"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NATS_URL
            value: "nats://custom:4222"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NATS_ACCOUNT
            value: "test-account"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NATS_SIGNING_KEY_FILE
            value: "/etc/nats/signing.key"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: K8S_IN_CLUSTER
            value: "true"

  - it: should use default NATS URL when not specified
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NATS_URL
            value: "nats://nats:4222"

  - it: should set optional JWT environment variables when provided
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      jwt:
        issuer: "https://custom-issuer"
        audience: "custom-audience"
        jwksUrl: "https://custom-jwks"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: JWT_ISSUER
            value: "https://custom-issuer"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: JWT_AUDIENCE
            value: "custom-audience"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: JWKS_URL
            value: "https://custom-jwks"

  - it: should not set JWT env vars when not provided
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: JWT_ISSUER
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: JWT_AUDIENCE
      - notContains:
          path: spec.template.spec.containers[0].env
          content:
            name: JWKS_URL

  - it: should set log level correctly
    set:
      logLevel: debug
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: LOG_LEVEL
            value: "debug"

  - it: should set NATS_USER_CREDS_FILE when userCredentials provided
    set:
      nats:
        account: "test-account"
        userCredentials:
          existingSecret: "user-creds-secret"
        signingKey:
          existingSecret: "signing-key-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NATS_USER_CREDS_FILE
            value: "/etc/nats/user.creds"

  - it: should set NATS_TOKEN when token provided
    set:
      nats:
        account: "test-account"
        token: "test-token"
        signingKey:
          existingSecret: "signing-key-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: NATS_TOKEN
            value: "test-token"

  - it: should mount signing key volume correctly
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
          existingSecretKey: "signing-key"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: nats-signing-key
            mountPath: /etc/nats/signing.key
            subPath: signing-key
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: nats-signing-key
            secret:
              secretName: test-secret

  - it: should mount user credentials volume when provided
    set:
      nats:
        account: "test-account"
        userCredentials:
          existingSecret: "user-creds-secret"
          existingSecretKey: "user.creds"
        signingKey:
          existingSecret: "signing-key-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: nats-user-credentials
            mountPath: /etc/nats/user.creds
            subPath: user.creds
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: nats-user-credentials
            secret:
              secretName: user-creds-secret

  - it: should mount created secret when signingKey.create=true
    set:
      nats:
        account: "test-account"
        signingKey:
          create: true
          content: "test-signing-key-content"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: nats-signing-key
            secret:
              secretName: RELEASE-NAME-nats-k8s-oidc-callout-nats-signing-key

  - it: should set resource limits and requests
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      resources:
        limits:
          cpu: "1"
          memory: 512Mi
        requests:
          cpu: 200m
          memory: 256Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "1"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 200m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi

  - it: should apply pod annotations when provided
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "8080"

  - it: should apply node selector when provided
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      nodeSelector:
        disktype: ssd
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.disktype
          value: ssd

  - it: should apply tolerations when provided
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      tolerations:
        - key: "key1"
          operator: "Equal"
          value: "value1"
          effect: "NoSchedule"
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0].key
          value: key1
      - equal:
          path: spec.template.spec.tolerations[0].operator
          value: Equal

  - it: should apply affinity when provided
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: "kubernetes.io/hostname"
                    operator: "In"
                    values:
                      - "node1"
    asserts:
      - isNotEmpty:
          path: spec.template.spec.affinity
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: kubernetes.io/hostname

  - it: should fail when nats.account is not set
    set:
      nats:
        signingKey:
          existingSecret: "test-secret"
    asserts:
      - failedTemplate:
          errorMessage: "nats.account is required"

  - it: should fail when signingKey not provided
    set:
      nats:
        account: "test-account"
    asserts:
      - failedTemplate:
          errorMessage: "nats.signingKey.existingSecret is required when nats.signingKey.create=false"

  - it: should use correct service account name when created
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      serviceAccount:
        create: true
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-nats-k8s-oidc-callout

  - it: should use custom service account name when provided
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      serviceAccount:
        create: true
        name: "custom-sa"
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: custom-sa

  - it: should use default service account when not created
    set:
      nats:
        account: "test-account"
        signingKey:
          existingSecret: "test-secret"
      serviceAccount:
        create: false
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: default