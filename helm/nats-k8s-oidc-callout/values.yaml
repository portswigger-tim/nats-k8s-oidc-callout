# Default values for nats-k8s-oidc-callout

# -- Number of replicas
replicaCount: 1

image:
  # -- Container image repository
  repository: ghcr.io/portswigger-tim/nats-k8s-oidc-callout
  # -- Image pull policy
  pullPolicy: IfNotPresent
  # -- Overrides the image tag (default is the chart appVersion)
  tag: ""

nats:
  # -- NATS server URL (can include embedded auth: nats://user:pass@host:port)
  # @default -- `nats://nats:4222`
  url: ""

  # -- NATS account name for the auth callout service (REQUIRED)
  account: ""

  # Connection Authentication (optional - pick one method or use URL-embedded auth)
  userCredentials:
    # -- Create a new secret for NATS user credentials
    create: false
    # -- Content of the user credentials file (required if create=true). Use `--set-file nats.userCredentials.content=path/to/user.creds`
    content: ""

    # -- Name of existing secret containing NATS user credentials (required if create=false and using credentials file)
    existingSecret: ""
    # -- Key in the existing secret that contains the user credentials file
    existingSecretKey: "user.creds"

  # -- NATS token for authentication (alternative to userCredentials)
  token: ""

  # Authorization Signing (REQUIRED)
  signingKey:
    # -- Create a new secret for NATS account signing key
    create: false
    # -- Content of the signing key file (required if create=true). Use `--set-file nats.signingKey.content=path/to/signing.key`
    content: ""

    # -- Name of existing secret containing NATS account signing key (REQUIRED if create=false)
    existingSecret: ""
    # -- Key in the existing secret that contains the signing key
    existingSecretKey: "signing.key"

jwt:
  # -- JWT issuer for token validation
  # @default -- `https://kubernetes.default.svc` (in-cluster)
  issuer: ""
  # -- JWT audience for token validation
  # @default -- `nats`
  audience: ""
  # -- JWKS URL for JWT validation
  # @default -- `https://kubernetes.default.svc/openid/v1/jwks` (in-cluster)
  jwksUrl: ""

# -- Log level (debug, info, warn, error)
logLevel: info

# -- Secret values mounted as environment variables (from SOPS secrets.yaml)
# Format: KEY: value (will be base64 encoded automatically)
secretEnv: {}
  # NATS_URL: nats://auth-service:password@nats:4222

# -- Secret values mounted as files in /secrets directory
# Format: filename: <base64-encoded-content>
secretVolume: {}

# -- Resource limits and requests
resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

rbac:
  # -- Create ClusterRole and ClusterRoleBinding for ServiceAccount access
  create: true

serviceAccount:
  # -- Specifies whether a service account should be created
  create: true
  # -- Annotations to add to the service account
  annotations: {}
  # -- The name of the service account to use (generated if not set)
  name: ""

# -- Annotations to add to the pod
podAnnotations: {}

# -- Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  fsGroup: 65532

# -- Container security context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true

# -- Node labels for pod assignment
nodeSelector: {}

# -- Tolerations for pod assignment
tolerations: []

# -- Affinity for pod assignment
affinity: {}

networkPolicy:
  # -- Enable NetworkPolicy
  enabled: false

  # -- NATS server port for egress rules
  # @default -- `4222`
  natsPort: 4222

  # -- Custom ingress rules (if not specified, allows port 8080 from anywhere in cluster)
  ingress: []
  # - ports:
  #   - protocol: TCP
  #     port: 8080
  #   from:
  #   - namespaceSelector:
  #       matchLabels:
  #         kubernetes.io/metadata.name: monitoring

  # -- Custom egress rules (if not specified, allows DNS, NATS, and K8s API)
  egress: []
  # - ports:
  #   - protocol: TCP
  #     port: 4222
  #   to:
  #   - podSelector:
  #       matchLabels:
  #         app: nats

  # -- Selector for NATS pods (used in default egress rules)
  natsSelector: []
  # - namespaceSelector:
  #     matchLabels:
  #       kubernetes.io/metadata.name: nats-system
  #   podSelector:
  #     matchLabels:
  #       app: nats

metrics:
  podMonitor:
    # -- Enable PodMonitor creation for Prometheus Operator
    enabled: false

    # -- Target namespace for PodMonitor (defaults to release namespace)
    namespace: ""

    # -- Additional labels for PodMonitor
    labels: {}

    # -- Additional annotations for PodMonitor
    annotations: {}

    # -- Metrics path
    # @default -- `/metrics`
    path: /metrics

    # -- Scrape interval (e.g., 30s, 1m)
    interval: ""

    # -- Scrape timeout (e.g., 10s)
    scrapeTimeout: ""

    # -- RelabelConfigs to apply to samples before scraping
    relabelings: []
    # - sourceLabels: [__meta_kubernetes_pod_node_name]
    #   targetLabel: node

    # -- MetricRelabelConfigs to apply to samples before ingestion
    metricRelabelings: []
    # - sourceLabels: [__name__]
    #   regex: '(go_.*)'
    #   action: drop

logs:
  podLogs:
    # -- Enable PodLogs creation for Grafana Agent Operator
    enabled: false

    # -- Target namespace for PodLogs (defaults to release namespace)
    namespace: ""

    # -- Additional labels for PodLogs
    labels: {}

    # -- Additional annotations for PodLogs
    annotations: {}

    # -- Pipeline stages for log processing
    # @default -- `[{"cri": {}}]` (CRI log format parser)
    pipelineStages: []
    # - cri: {}
    # - json:
    #     expressions:
    #       level: level
    #       msg: msg
    # - labels:
    #     level:

    # -- RelabelConfigs to apply to logs before ingestion
    relabelings: []
    # - sourceLabels: [__meta_kubernetes_pod_node_name]
    #   targetLabel: node

# -- Additional Kubernetes objects to deploy (e.g., ConfigMaps, Secrets, etc.)
# Supports templating with `tpl` function
extraObjects: []
# - apiVersion: v1
#   kind: ConfigMap
#   metadata:
#     name: {{ include "nats-k8s-oidc-callout.fullname" . }}-extra
#   data:
#     key: value
