suite: test secret
templates:
  - secret.yaml
tests:
  - it: should create a Secret when nats.credentials.create is true
    set:
      nats:
        account: "test-account"
        credentials:
          create: true
          content: "test-credentials-content"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-nats-k8s-oidc-callout-nats-creds
      - matchRegex:
          path: metadata.labels["helm.sh/chart"]
          pattern: ^nats-k8s-oidc-callout-
      - equal:
          path: type
          value: Opaque

  - it: should base64 encode the credentials content
    set:
      nats:
        account: "test-account"
        credentials:
          create: true
          content: "test-credentials-content"
    asserts:
      - equal:
          path: data.credentials
          value: "dGVzdC1jcmVkZW50aWFscy1jb250ZW50"

  - it: should not create Secret when nats.credentials.create is false
    set:
      nats:
        account: "test-account"
        credentials:
          create: false
          existingSecret: "existing-secret"
    asserts:
      - hasDocuments:
          count: 0

  - it: should fail when credentials.content is not provided with create=true
    set:
      nats:
        account: "test-account"
        credentials:
          create: true
    asserts:
      - failedTemplate:
          errorMessage: "nats.credentials.content is required when nats.credentials.create=true"
